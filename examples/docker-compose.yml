# Example: add this service to your project's docker-compose.yml
# Requires: image "claude-node-git" (run "yarn claude" in telegram-code once to build it)

services:
  telegram-code:
    image: claude-node-git
    container_name: telegram-code-bot
    user: root
    stdin_open: true
    tty: true
    working_dir: /workspace
    volumes:
      # Your project
      - .:/workspace:rw
      # telegram-code source (adjust path)
      - ../telegram-code:/telegram-code:ro
      - ../telegram-code/.docker-entrypoint.sh:/docker-entrypoint.sh:ro
      # Persist home (npm installs, CLI configs, session history)
      - telegram_code_home:/home/agent:rw
      # Host configs
      - ~/.gitconfig:/tmp/host-gitconfig:ro
      - ~/.ssh:/tmp/host-ssh:ro
      # OpenCode config and state from host (persists model selection)
      - ~/.config/opencode:/home/agent/.config/opencode:rw
      - ~/.local/state/opencode:/home/agent/.local/state/opencode:rw
      # Optional: custom opencode binary (built from fork)
      # Build: cd opencode-fork/packages/opencode && bun run build
      # - ../opencode-fork/packages/opencode/dist/opencode-linux-x64/bin/opencode:/opt/opencode:ro
    environment:
      - HOME=/home/agent
      - TERM=xterm-256color
      - TARGET_UID=${UID:-501}
      - TARGET_GID=${GID:-20}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - ALLOWED_USERS=${ALLOWED_USERS}
      - WORK_DIR=/workspace
      - DEFAULT_AGENT=opencode
      # API keys for providers
      - GROQ_API_KEY=${GROQ_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      # Optional: use custom opencode binary
      # - OPENCODE_BIN=/opt/opencode
    entrypoint: ["/bin/bash", "/docker-entrypoint.sh"]
    command: ["npx", "tsx", "/telegram-code/src/index.ts"]
    restart: unless-stopped

volumes:
  telegram_code_home:
